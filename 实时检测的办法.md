# 实时监控训练进度的两种方法

在进行深度学习模型训练时,尤其是在远程服务器上执行长时间任务时,能够实时监控训练进度、查看损失函数、验证指标以及生成的图像样本至关重要. 本项目提供了两种互补的方法来实现这一目标.

---

## 方法一: 云端实时仪表盘 (Weights & Biases)

这是一种功能强大且灵活的远程监控方法, 适用于任何网络环境下的长时间、严肃的训练任务.

### 1. 思路

该方法通过集成 **Weights & Biases (`wandb`)** 这一第三方服务来实现.

- **工作原理**: 训练脚本在运行时, 会将所有的关键指标 (如损失、学习率、PSNR等) 以及验证阶段生成的图片样本, 实时地发送到 `wandb` 的云端服务器.
- **实时监控**: 你可以在任何有网络的设备上, 通过浏览器登录 `wandb` 网站, 查看为你这次训练任务自动生成的仪表盘 (Dashboard). 仪表盘包含了所有指标的实时变化曲线、配置信息、服务器状态以及图像样本.
- **持久化与不中断**: 即使你关闭本地电脑或断开与训练服务器的 SSH 连接, 只要服务器上的训练进程没有中断, 日志就会持续不断地上传. 你可以随时回来查看进度.

### 2. 具体使用方法

1.  **安装与登录**:
    ```bash
    # 在你的训练环境中安装 wandb 库
    pip install wandb

    # 登录你的 wandb 账户 (会提示你输入 API Key)
    wandb login
    ```

2.  **修改配置文件**:
    在你要使用的训练配置文件 (`.yml` 格式, 位于 `options/train/` 目录下) 中, 找到或添加 `logger` -> `wandb` 部分, 并指定一个项目名称.

    **示例 (`.yml` 文件):**
    ```yaml
    # logger settings
    logger:
      print_freq: 100
      save_checkpoint_freq: !!float 5e3
      use_tb_logger: true
      wandb:
        project: 'your_project_name' # 在这里填上你的项目名
        # resume_id: ~  # 如果要断点续训, 可以填上上次的 run id
    ```

3.  **开始训练**:
    像往常一样启动训练脚本. 程序启动时, 控制台会打印出 `wandb` 的相关信息, 包括一个指向你的在线仪表盘的链接.

4.  **查看仪表盘**:
    打开控制台输出的链接, 即可在浏览器中实时查看训练进度.

### 3. 核心代码与函数

- **`wandb` 初始化**:
  - **文件**: `BasicSR/basicsr/utils/logger.py`
  - **函数**: `init_wandb_logger(opt)`
  - **代码**:
    ```python
    def init_wandb_logger(opt):
        """We now only use wandb to sync tensorboard log."""
        import wandb

        project = opt['logger']['wandb']['project']
        resume_id = opt['logger']['wandb'].get('resume_id')
        if resume_id:
            wandb_id = resume_id
        else:
            wandb_id = wandb.util.generate_id()

        wandb.init(id=wandb_id, resume='allow', name=opt['name'], config=opt, project=project, sync_tensorboard=True)
        logger.info(f'Use wandb logger with id={wandb_id}; project={project}.')
    ```
  - **分析**: 此函数负责根据配置文件内容调用 `wandb.init()`, 启动一次 `wandb` 运行 (`run`). `sync_tensorboard=True` 参数是关键, 它让 `wandb` 自动捕获所有 `TensorBoard` 的日志, 无需额外代码.

- **训练流程调用**:
  - **文件**: `BasicSR/basicsr/train.py`
  - **分析**: 在训练开始前的设置阶段, 脚本会检查配置文件中是否启用了 `wandb`, 如果启用, 则调用 `init_wandb_logger()` 函数.

---

## 方法二: 本地终端仪表盘 (CLI Dashboard)

这是一种轻量级的本地监控方法, 无需网络连接, 非常适合快速的本地调试和监控.

### 1. 思路

- **工作原理**: 训练脚本在运行时, 会将每一轮的指标追加写入到一个 CSV 格式的日志文件 (`training_log.csv`) 中. `dashboard.py` 脚本则是一个独立的命令行工具, 它使用 Python 的 `curses` 库来创建一个文本用户界面 (TUI). 这个界面会周期性地重新读取 CSV 文件, 并将最新的指标格式化后显示在当前的终端窗口中.
- **优点**: 轻量、快速、无网络依赖.

### 2. 具体使用方法

1.  **开始训练**:
    正常启动训练. 确保在 `logger` 配置中, `save_checkpoint_freq` 等设置合理, 以便日志被频繁记录. 训练开始后, 会在实验目录下 (`experiments/your_experiment_name/`) 生成 `training_log.csv` 文件.

2.  **启动仪表盘**:
    打开一个新的终端窗口, 运行 `srctraining/dashboard.py` 脚本, 并通过 `--csv` 参数指向正在生成的日志文件.

    ```bash
    python srctraining/dashboard.py --csv experiments/your_experiment_name/training_log.csv
    ```

3.  **查看与退出**:
    终端会变成一个实时刷新的仪表盘, 显示最新的损失值和历史统计. 按 `q` 键即可退出仪表盘.

### 3. 核心代码与函数

- **文件**: `srctraining/dashboard.py`
- **函数**: `main()` 和 `run_dashboard()`
- **代码**:
  ```python
  def main():
      ap = argparse.ArgumentParser(description='CLI dashboard for training metrics')
      ap.add_argument('--csv', default='experiments/StageL_LongTrain_RealESRGANStyle/training_log.csv', type=str)
      ap.add_argument('--refresh', default=1.0, type=float)
      args = ap.parse_args()
      curses.wrapper(run_dashboard, args.csv, args.refresh)

  if __name__ == '__main__':
      main()
  ```
- **分析**: 脚本的入口是 `main` 函数, 它解析命令行参数 (如CSV文件路径和刷新频率), 然后使用 `curses.wrapper()` 来安全地启动 `run_dashboard` 函数. `run_dashboard` 内含一个主循环, 不断调用 `load_metrics` 读取CSV文件, 并调用 `draw_dashboard` 刷新终端屏幕.

---

## 总结

| 特性 | 云端仪表盘 (`wandb`) | 本地终端仪表盘 (CLI) |
| :--- | :--- | :--- |
| **优点** | 功能强大, 图表丰富, 可视化效果好, 可远程访问, 永久记录 | 轻量级, 启动快, 无需网络, 资源占用少 |
| **缺点** | 依赖网络和第三方服务, 配置稍复杂 | 仅文本界面, 信息量有限, 只能本地查看 |
| **适用场景** | 重要的、长时间的、在远程服务器上运行的训练任务 | 本地开发、快速调试、或在无外网环境下监控 |

建议在正式训练时使用 `wandb` 进行全面记录, 在本地开发调试时使用 CLI 仪表盘进行快速查看.
